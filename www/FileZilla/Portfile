# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 104704 2013-04-01 03:14:41Z jeremyhu@macports.org $

PortSystem          1.0

name                FileZilla
version             3.7.3
revision            0
categories          www aqua
platforms           darwin
maintainers         strasweb.fr:rudloff openmaintainer
license             GPL-2+

description         Open-source FTP, FTPS, and SFTP client

long_description    FileZilla Client is a fast and reliable \
                    cross-platform FTP, FTPS and SFTP client with lots \
                    of useful features and an intuitive graphical user \
                    interface.

homepage            http://filezilla-project.org/
master_sites        sourceforge:project/filezilla/${name}_Client/${version}

checksums           sha1    34c3dd1943816a916c54e49cbbea51c97ef3f583 \
                    rmd160  8fefebae9f2024dedab9841dc6fe3876305f8d2f \
                    sha256  2b012970a6033d8ffd4629b1d57b50ace62cd3750efad70001109f25e520c042

depends_build-append \
                    port:pkgconfig \
                    path:bin/gmake:gmake \
                    path:share/aclocal/ax_check_gnu_make.m4:autoconf-archive \
                    bin:uuid:ossp-uuid

depends_lib-append  port:wxWidgets \
                    port:libidn \
                    port:gettext \
                    port:libgpg-error \
                    port:libgcrypt \
                    port:gnutls2 \
                    port:sqlite3 \
                    port:libiconv \
                    port:libtasn1 \
                    port:zlib \
                    path:include/tinyxml.h:tinyxml

depends_run-append  bin:xdg-open:xdg-utils

# wxWidgets is 32-bit only
supported_archs     i386 ppc

# wxWidgets is not universal
# Neither is FileZilla itself for that matter... universal builds are rejected
# automatically due some lines in the configure.ac file
universal_variant   no

distname            ${name}_${version}_src
use_bzip2           yes
worksrcdir          filezilla-${version}

patchfiles-append   patch-configure.ac.diff

pre-patch {
    if {![file exists ${worksrcpath}/configure.ac]} {
        file rename ${worksrcpath}/configure.in ${worksrcpath}/configure.ac
    }
}

post-patch {
    file copy ${prefix}/share/aclocal/ax_check_gnu_make.m4 ${worksrcpath}/m4
    eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/*/Makefile.am]
    eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/src/*/Makefile.am]
    eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/src/putty/*/Makefile.am]
    # Run glibtoolize before autoreconf runs it, to silence some warnings
    system -W ${worksrcpath} "${prefix}/bin/glibtoolize --copy --force --install --quiet"
}

use_autoreconf      yes
autoreconf.args     -fvi

# http://sourceforge.net/tracker/index.php?func=detail&aid=3031828&group_id=13559&atid=313559
configure.args      --with-tinyxml=builtin \
                    --disable-manualupdatecheck \
                    --disable-autoupdatecheck \
                    --with-wx-config=${prefix}/bin/wx-config \
                    --with-wx-prefix=${prefix} \
                    --without-dbus \
                    --disable-precomp \
                    --with-libgnutls-prefix=${prefix}/lib/gnutls2

configure.env-append \
                    WXRC=${prefix}/bin/wxrc

configure.cppflags-append \
                    -I${worksrcpath}/src/include \
                    -I${prefix}/lib/gnutls2/include \
                    -I${prefix}/lib/gnutls2/include/gnutls

configure.ldflags-append \
                    -L${prefix}/lib/gnutls2/lib

configure.pkg_config_path-append \
                    ${prefix}/lib/gnutls2/lib/pkgconfig

configure.ccache    no
configure.distcc    no
configure.optflags  ""
configure.pipe      no

# needs c++11 support
compiler.blacklist-append \
                    cc gcc gcc-3.3 gcc-4.0 gcc-4.2 clang apple-gcc-4.0 \
                    apple-gcc-4.2 llvm-gcc-4.2 macports-llvm-gcc-4.2 \
                    macports-clang macports-clang-2.9 macports-gcc \
                    macports-gcc-4.2
compiler.fallback-append \
                    macports-gcc-4.9 macports-gcc-4.8 macports-gcc-4.7 \
                    macports-gcc-4.6 macports-gcc-4.5 macports-gcc-4.4 \
                    macports-gcc-4.3 macports-dragonegg-3.4 \
                    macports-dragonegg-3.3 macports-dragonegg-3.2 \
                    macports-dragonegg-3.1

build.type          gnu
build.cmd           ${prefix}/bin/gmake

# "use_parallel_build no" is set here due to the following error:
# cp: fzputtygen: No such file or directory
use_parallel_build  no

post-destroot {
    xinstall -d ${prefix}/share/doc/${name}
    xinstall -m 644 -W ${worksrcpath} AUTHORS COPYING ChangeLog NEWS \
        README TODO ${destroot}${docdir}

    copy ${worksrcpath}/${name}.app ${destroot}${applications_dir}
}

if {${os.platform} != "darwin"} {
    variant dbus description {Build dbus support} {
        depends_lib-append \
                        path:bin/dbus-launch:dbus
        configure.args-delete \
                        --without-dbus
        configure.args-append \
                        --with-dbus
    }
    depends_build-append \
                        bin:makensis:nsis
}

variant test description {Build tests for cppunit} {
    depends_lib-append \
                    port:cppunit
    configure.args-append \
                    --with-cppunit-prefix=${prefix}

    test.run        yes
    test.target     check
}
