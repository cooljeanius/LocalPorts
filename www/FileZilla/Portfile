# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 104704 2013-04-01 03:14:41Z jeremyhu@macports.org $

PortSystem          1.0

name                FileZilla
version             3.5.1
revision            2
categories          www aqua
platforms           darwin
maintainers         strasweb.fr:rudloff openmaintainer
license             GPL-2+

description         Open-source FTP, FTPS, and SFTP client

long_description    FileZilla Client is a fast and reliable \
                    cross-platform FTP, FTPS and SFTP client with lots \
                    of useful features and an intuitive graphical user \
                    interface.

homepage            http://filezilla-project.org/
master_sites        sourceforge:project/filezilla/${name}_Client/${version}

checksums           sha1    e4b2048cf8740e05cfff8e444a9059f79784e3f6 \
                    rmd160  6f5c7e9db07cb1b5cc43de194f35a032a6f966b8 \
                    sha256  62abc6a7ced8e92a2a557c58935c773d656bd211aa937313f435a0d4b763ab05

depends_build-append \
                    port:pkgconfig \
                    port:gmake \
                    port:autoconf-archive \
                    bin:uuid:ossp-uuid

depends_lib-append  port:wxWidgets \
                    port:libidn \
                    port:gettext \
                    port:libgpg-error \
                    port:libgcrypt \
                    port:gnutls2 \
                    port:sqlite3 \
                    port:libiconv \
                    port:libtasn1 \
                    port:zlib

depends_run-append  bin:xdg-open:xdg-utils

# wxWidgets is 32-bit only
supported_archs     i386 ppc

# wxWidgets is not universal
# Neither is FileZilla itself for that matter... universal builds are rejected
# automatically due some lines in the configure.ac file
universal_variant   no

distname            ${name}_${version}_src
use_bzip2           yes
worksrcdir          filezilla-${version}

patchfiles-append   patch-configure.ac.diff \
                    patch-m4_check_cxx0x.m4.diff

pre-patch {
    file rename ${worksrcpath}/configure.in ${worksrcpath}/configure.ac
}

post-patch {
    file copy ${prefix}/share/aclocal/ax_check_gnu_make.m4 ${worksrcpath}/m4
    eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/*/Makefile.am]
    eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/src/*/Makefile.am]
    eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/src/putty/*/Makefile.am]
    # Run glibtoolize before autoreconf runs it, to silence some warnings
    system -W ${worksrcpath} "glibtoolize --copy --force --install"
}

use_autoreconf      yes
autoreconf.args     -fvi

# http://sourceforge.net/tracker/index.php?func=detail&aid=3031828&group_id=13559&atid=313559
configure.args      --with-tinyxml=builtin \
                    --disable-manualupdatecheck \
                    --disable-autoupdatecheck \
                    --with-wx-config=${prefix}/bin/wx-config \
                    --with-wx-prefix=${prefix} \
                    --without-dbus \
                    --disable-precomp \
                    --with-libgnutls-prefix=${prefix}/lib/gnutls2

configure.cppflags-append \
                    -I${worksrcpath}/src/include \
                    -I${prefix}/lib/gnutls2/include \
                    -I${prefix}/lib/gnutls2/include/gnutls

configure.ldflags-append \
                    -L${prefix}/lib/gnutls2/lib

configure.pkg_config_path-append \
                    ${prefix}/lib/gnutls2/lib/pkgconfig

configure.ccache    no

build.type          gnu
build.cmd           ${prefix}/bin/gmake

# "use_parallel_build no" is set here due to the following error:
# cp: fzputtygen: No such file or directory
use_parallel_build  no

post-destroot {
    xinstall -d ${prefix}/share/doc/${name}
    xinstall -m 644 -W ${worksrcpath} AUTHORS COPYING ChangeLog NEWS README \
        TODO ${destroot}${docdir}

    copy ${worksrcpath}/${name}.app ${destroot}${applications_dir}
}

if {${os.platform} != "darwin"} {
    variant dbus description {Build dbus support} {
        depends_lib-append \
                        path:bin/dbus-launch:dbus
        configure.args-delete \
                        --without-dbus
        configure.args-append \
                        --with-dbus
    }
}

variant test description {Build tests for cppunit} {
    depends_lib-append \
                    port:cppunit
    configure.args-append \
                    --with-cppunit-prefix=${prefix}

    test.run        yes
    test.target     check
}
