# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 105815 2013-05-06 14:52:20Z landonf@macports.org $

PortSystem          1.0

name                dpkg
version             1.16.12
revision            1
platforms           darwin freebsd
categories          sysutils archivers
license             GPL-2+
maintainers         gwmail.gwu.edu:egall openmaintainer
description         Debian package maintenance system
long_description    ${name} is the basis of the ${description}. \
                    Installing this port allows the usage of the \
                    \`port dpkg\` command.

homepage            http://wiki.debian.org/Teams/Dpkg

master_sites        debian:d/${name}/
checksums           md5     b7e9cac52ff7882b088a3058b52081b5 \
                    sha1    5969bb7f30ade840a56f512571ca5ab56d434af1 \
                    rmd160  1912afd35b835901e661d2c0df563198de4e8420 \
                    sha256  af96447758ecbfda51fc57d4b3bc3d208ad6393e71b91c9b52c6687697a208da

use_xz              yes
extract.asroot      yes

depends_build-append \
                    port:pkgconfig \
                    port:autoconf-archive \
                    port:xorg-util-macros \
                    port:gnutar \
                    port:perl5 \
                    bin:git:git-core \
                    bin:lzma:xz

# Use MacPorts versions explicitly
depends_lib-append  port:gettext \
                    port:libiconv \
                    port:perl5 \
                    port:coreutils \
                    port:bzip2 \
                    port:zlib \
                    port:ncurses \
                    port:gnutar \
                    path:lib/pkgconfig/liblzma.pc:xz

depends_run-append  port:gnutar \
                    bin:lzma:xz \
                    bin:gzip:gzip \
                    bin:perl:perl5 \
                    port:debianutils

# got to do some underscore-to-hyphen twiddling...
distname            ${name}_${version}
worksrcdir          ${name}-${version}

configure.perl      ${prefix}/bin/perl5
configure.pkg_config ${prefix}/bin/pkg-config
configure.env-append TAR=${prefix}/bin/gnutar \
                     POD2MAN=${prefix}/bin/pod2man
configure.args-append \
                    --with-libintl-prefix=${prefix} \
                    --with-libiconv-prefix=${prefix} \
                    --with-admindir=${prefix}/var/db/${name} \
                    --with-logdir=${prefix}/var/log \
                    --mandir=${prefix}/share/man \
                    --with-zlib \
                    --with-bz2 \
                    --with-liblzma \
                    --disable-linker-optimisations \
                    --disable-silent-rules
# Got the start-stop-daemon to build again, no longer have to disable it
# with a configure flag here!

# ccache is trouble
configure.ccache          no

# Older versions of gcc choke with the -Wvla warning flag:
configure.cflags-delete   -Wvla
configure.cppflags-delete -Wvla
configure.cxxflags-delete -Wvla
configure.ldflags-delete  -Wvla

# Also -Wmissing-declarations is not valid for C++:
configure.cxxflags-delete -Wmissing-declarations

post-configure {
    #TODO: maybe use 'fs-traverse' here?
    reinplace "s|-Wvla||" ${worksrcpath}/Makefile
    eval reinplace "s|-Wvla||" [glob ${worksrcpath}/*/Makefile]
    eval reinplace "s|-Wvla||" [glob ${worksrcpath}/lib/*/Makefile]
    reinplace "s|-Wvla||" ${worksrcpath}/lib/dpkg/test/Makefile
    reinplace "s|-Wmissing-declarations||" ${worksrcpath}/dselect/Makefile
}

compiler.blacklist-append cc gcc-3.3 gcc-4.0 apple-gcc-4.0

build.type          gnu

set vardpkg ${destroot}${prefix}/var/db/${name}
destroot.keepdirs-append \
                    ${vardpkg} \
                    ${vardpkg}/updates \
                    ${vardpkg}/info \
                    ${destroot}${prefix}/var/log \
                    ${destroot}${prefix}/etc/${name}

patchfiles-append   patch-configure.ac.diff \
                    patch-lib_dpkg_dpkg.h.diff \
                    patch-lib_dpkg_tarfn.c.diff \
                    patch-src_remove.c.diff \
                    patch-src_archives.c.diff \
                    patch-utils_start-stop-daemon.c.diff
# patchfiles:
# - configure.ac: new patch, runs autoupdate and makes some other configury
#   changes that I normally like to make
# - lib/dpkg/dpkg.h: used to be "patch-lib_dpkg.h", forces the use of
#   gnutar instead of just "tar"
# - lib/dpkg/tarfn.c: used to be "patch-lib_tarfn.c", adds support for
#   dpkgs built with the ustar format, which fixes long filename handling
#   when not using gnutar. It also fixes a bug in dpkg's stripping of '/'
#   characters when there were not any.
# - src/archives.c: used to be "patch-main_achives.c", also adds support
#   for handling format differences between bsdtar and gnutar related to
#   pathname prefixes
# - src/remove.c: used to be "patch-main_remove.c", fixes the issue of
#   removing the last package on the system causing issues due to the
#   inclusion of '/.'
# - utils/start-stop-daemon.c: formerly "patch-utils_start-stop-daemon.c",
#   it adds Mac OS X support to the various process handling functions
#   debian uses to start/stop/monitor daemons. Still had to be disabled
#   with a configure flag for a while though (see above)


patch.args-append   --backup

post-patch {
    set scripts ${worksrcpath}/scripts
    reinplace "s|/etc/${name}/|${prefix}/etc/${name}/|" \
            ${scripts}/${name}-shlibdeps.pl \
            ${scripts}/${name}-source.pl
    reinplace "s|AC_ERROR|AC_MSG_ERROR|" ${worksrcpath}/m4/dpkg-build.m4
    file copy ${prefix}/share/aclocal/ax_check_gnu_make.m4 ${worksrcpath}/m4
    file copy ${prefix}/share/aclocal/xorg-macros.m4 ${worksrcpath}/m4
    # build system seems to expect it to be in a git repo:
    system -W ${worksrcpath} "git init"
}

use_autoreconf      yes
autoreconf.args     -fvi --warnings=all

pre-destroot {
    file mkdir ${destroot}${prefix}/share/doc/${name}
}

post-destroot {
    file mkdir ${vardpkg}
    file mkdir ${vardpkg}/updates
    file mkdir ${vardpkg}/info
    system "touch ${vardpkg}/available ${vardpkg}/status"
}

# These platform variants had previously had patches associated
# with them...
platform darwin {
    depends_build-append    bin:gnumake:gmake
}

platform freebsd {
    depends_build-append    bin:gmake:gmake
}

# This variant sometimes hangs while building...
variant docs description {Build documentation (warning: building documentation takes a long time)} {
    depends_build-append    port:doxygen \
                            path:bin/dot:graphviz \
                            port:fontconfig \
                            port:freefont-ttf
    set docdir ${prefix}/share/doc/${name}
    configure.args-append   --docdir=${docdir} \
                            --htmldir=${docdir}/html \
                            --dvidir=${docdir}/dvi \
                            --pdfdir=${docdir}/pdf \
                            --psdir=${docdir}/ps
    build.target-append     doc
    pre-build {
        elevateToRoot "doxygen"
        system -W ${worksrcpath}/doc "${prefix}/bin/doxygen -u"
    }
    post-build {
        system -W ${worksrcpath}/doc "${prefix}/bin/doxygen"
        dropPrivileges
        set destroot_docdir ${destroot}${prefix}/share/doc/${name}
        xinstall -d ${destroot_docdir}
        copy ${worksrcpath}/doc/doc ${destroot_docdir}
        copy ${worksrcpath}/doc/html ${destroot_docdir}
        foreach docfile {coding-style.txt triggers.txt README.feature-removal-schedule frontend.txt README.api} {
            xinstall -m 644 ${worksrcpath}/doc/${docfile} ${destroot_docdir}
        }
    }
}

# Tests currently fail, this needs to be fixed eventually:
test.run            yes
test.target         check

pre-test {
    elevateToRoot "test"
}
post-test {
    dropPrivileges
}

# odd-numbered releases are unstable, so ignore them
livecheck.type      none
livecheck.url       http://ftp.debian.org/debian/pool/main/d/${name}/
livecheck.regex     "${name}_(\\d+\\.\\d+(\\.\\d+)*)"
