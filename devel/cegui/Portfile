# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 104415 2013-03-25 10:28:03Z ryandesign@macports.org $

PortSystem          1.0

PortGroup           conflicts_build 1.0

name                cegui
version             0.7.9
revision            1
categories          devel
platforms           darwin
license             MIT
maintainers         ryandesign openmaintainer

description         Crazy Eddie's GUI System

long_description    ${description} is a free library for game developers \
                    that provides windowing and widgets for graphics APIs \
                    and engines where such functionality is not natively \
                    available, or is severely lacking.

homepage            http://www.${name}.org.uk/
master_sites        sourceforge:project/crayzedsgui/CEGUI%20Mk-2/${version}
distname            CEGUI-${version}

checksums           rmd160  d776fd49a629248783b0d45b05ef8ad2804cca3b \
                    sha256  7c3b264def08b46de749c2acaba363e907479d924612436f3bd09da2e474bb8c

# should not be necessary any more now that xnu-headers installs elsewhere, but
# will have to check:
conflicts_build-append \
                    xnu-headers

depends_build-append \
                    port:pkgconfig \
                    path:bin/xmkmf:imake \
                    bin:gnutar:gnutar \
                    bin:zip:zip \
                    bin:unzip:unzip

depends_lib-append  port:expat \
                    port:freetype \
                    port:libxml2 \
                    port:pcre \
                    port:tinyxml \
                    port:xorg-libX11 \
                    port:xorg-libXau \
                    port:xorg-libXdmcp \
                    port:xorg-libXext \
                    port:xorg-libXi \
                    port:xorg-libXrandr \
                    port:xorg-libXxf86vm \
                    port:xorg-libice \
                    port:xorg-libsm \
                    port:xorg-libxcb \
                    port:xrender \
                    port:zlib \
                    port:bzip2 \
                    port:jasper \
                    port:jpeg \
                    port:lcms \
                    port:libiconv \
                    port:libmng \
                    port:libpng \
                    port:tiff \
                    port:xz

#TODO: add a patch for new freetype2 header locations
patchfiles-append   patch-cegui-include-CEGUIDynamicModule.h.diff \
                    patch-cegui-src-CEGUIDynamicModule.cpp.diff

configure.args-append \
                    --disable-corona \
                    --disable-external-glew \
                    --disable-irrlicht-renderer \
                    --disable-lua-module \
                    --disable-ogre-renderer \
                    --disable-python-module \
                    --disable-rapidxml \
                    --disable-samples \
                    --disable-silly \
                    --disable-stb \
                    --disable-tga \
                    --disable-xerces-c \
                    --disable-bidirectional-text \
                    --disable-devil \
                    --disable-freeimage \
                    --enable-freetype \
                    --enable-null-renderer \
                    --enable-pcre \
                    --enable-tinyxml \
                    --with-tinyxml-incdir=${prefix}/include \
                    --with-tinyxml-libdir=${prefix}/lib \
                    --enable-libxml \
                    --enable-expat \
                    --with-expat-incdir=${prefix}/include \
                    --with-expat-libdir=${prefix}/lib \
                    --disable-opengl-renderer \
                    --with-x \
                    --with-zlib=${prefix}

configure.env-append \
                    XMKMF=${prefix}/bin/xmkmf

configure.cppflags-append \
                    -I${prefix}/include/libxml2

variant huge requires autoreconf bidirectional debug devil external_glew freeimage lua opengl python xerces \
description {Build with all available features that build universal} {
    pre-fetch {
        ui_msg "Good luck with this variant (i.e. \"+huge\")..."
    }
}

variant autoreconf description {Runs autoreconf before configuring} {
    post-extract {
        file mkdir ${worksrcpath}/m4
        file copy ${worksrcpath}/aclocal.m4 ${worksrcpath}/m4
        file copy ${worksrcpath}/acinclude.m4 ${worksrcpath}/m4
        file copy ${prefix}/share/aclocal/pkg.m4 ${worksrcpath}/m4
    }
    patchfiles-append       patch-configure.ac.diff \
                            patch-Makefile.am.diff
    post-patch {
        eval reinplace "s|AC_HELP_STRING|AS_HELP_STRING|" [glob ${worksrcpath}/*.m4]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/Samples/*/Makefile.am]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/Samples/common/*/Makefile.am]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/cegui/*/Makefile.am]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/cegui/src/*/Makefile.am]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/cegui/src/*/*/Makefile.am]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/cegui/src/ScriptingModules/*ScriptModule/*/Makefile.am]
        eval reinplace "s|INCLUDES|AM_CPPFLAGS|" [glob ${worksrcpath}/cegui/src/ScriptingModules/*ScriptModule/support/*/Makefile.am]
    }
    use_autoreconf          yes
    autoreconf.args         -fvi --warnings=all
    depends_build-append    port:gawk \
                            port:grep \
                            port:gsed
    configure.args-append   --disable-silent-rules
    configure.cppflags-append \
                    -I${worksrcpath}/cegui/include \
                    -I${worksrcpath}/cegui/include/RendererModules/Null \
                    -I${worksrcpath}/cegui/include/falagard \
                    -I${worksrcpath}/cegui/include/WindowRendererSets/Falagard \
                    -I${worksrcpath}/cegui/include/XMLParserModules/TinyXMLParser \
                    -I${worksrcpath}/cegui/include/XMLParserModules/LibxmlParser \
                    -I${worksrcpath}/cegui/include/XMLParserModules/ExpatParser \
                    -I.
    use_parallel_build      no
    platform macosx {
        configure.cppflags-append \
                    -I${worksrcpath}/cegui/src/implementations/mac
        configure.ldflags-append \
                    "-framework CoreFoundation"
    }
}

variant debug description {Enable debugging} {
    configure.args-append --enable-debug
    configure.optflags    -g
}

variant xerces description {Build with xerces support} {
    depends_lib-append    path:lib/libxerces-c.dylib:xercesc
    configure.args-replace --disable-xerces-c --enable-xerces-c
    configure.args-append --with-xerces-incdir=${prefix}/include \
                          --with-xerces-libdir=${prefix}/lib
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/include/XMLParserModules/XercesParser
    }
}

variant devil description {Build with libdevil support} {
    depends_lib-append    port:libdevil
    configure.args-replace --disable-devil --enable-devil
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/include/ImageCodecModules/DevILImageCodec
    }
}

variant opengl description {Build with OpenGL support} {
    depends_lib-append    port:mesa \
                          port:freeglut
    depends_build-append  port:glui
    depends_skip_archcheck-append glui
    configure.args-replace --disable-opengl-renderer --enable-opengl-renderer
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/include/RendererModules/OpenGL
    }
}

variant external_glew requires opengl description {Build against an external GLEW} {
    depends_lib-append    port:glew
    configure.args-replace --disable-external-glew --enable-external-glew
    configure.args-append --with-glew-incdir=${prefix}/include \
                          --with-glew-libdir=${prefix}/lib
    configure.cppflags-append \
                          -I${prefix}/include/GL
    if {[variant_isset autoreconf]} {
        if {![file exists ${prefix}/include/GL/glew.h]} {
            configure.cppflags-append \
                          -I${worksrcpath}/cegui/src/RendererModules/OpenGL/GLEW \
                          -I${worksrcpath}/cegui/src/RendererModules/OpenGL/GLEW/GL
        }
    }
}

variant freeimage description {Build with libfreeimage support} {
    depends_lib-append    port:freeimage
    configure.args-replace --disable-freeimage --enable-freeimage
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/include/ImageCodecModules/FreeImageImageCodec
    }
}

# These variants are things that the trunk version of this portfile
# enables by default:
default_variants-append +freeimage+devil

# Ogre is not universal
variant ogre conflicts universal description {Enable support for the OGRE rendering engine} {
    depends_lib-append    port:ogre \
                          port:ois
    configure.args-replace --disable-ogre-renderer --enable-ogre-renderer
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/include/RendererModules/Ogre
    }
}

variant bidirectional description {Enable bidirectional text support} {
    depends_lib-append    port:fribidi
    configure.args-replace --disable-bidirectional-text --enable-bidirectional-text
    configure.cppflags-append \
                          -I${prefix}/include/fribidi
}

variant samples requires autoreconf description {Build samples with gtk2 (warning: not all work yet)} {
    depends_lib-append    port:gtk2
    configure.args-replace --disable-samples --enable-samples
    configure.args-append --with-gtk2
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/Samples/common/include
    }
    pre-build {
        ui_msg "Warning: This will probably fail."
    }
}

# Language bindings variants
variant lua description {Enable lua bindings} {
    depends_lib-append    port:lua \
                          port:swig-lua \
                          port:toluapp
    configure.args-replace --disable-lua-module --enable-lua-module
    configure.args-append --enable-toluacegui \
                          --enable-external-toluapp \
                          --with-tolua++-incdir=${prefix}/include \
                          --with-tolua++-libdir=${prefix}/lib
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/include/ScriptingModules/LuaScriptModule \
                          -I${worksrcpath}/cegui/include/ScriptingModules/LuaScriptModule/support/tolua++
    }
}

variant python description {Enable python bindings} {
    depends_lib-append    port:swig-python
    configure.args-replace --disable-python-module --enable-python-module
    if {[variant_isset autoreconf]} {
        configure.cppflags-append \
                          -I${worksrcpath}/cegui/src/ScriptingModules/PythonScriptModule/bindings/output/CEGUI
    }
}

livecheck.regex     /CEGUI-(\[0-9.\]+)${extract.suffix}
